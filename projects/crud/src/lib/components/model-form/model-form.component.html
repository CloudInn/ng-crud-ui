<div class="grid-spinner" *ngIf="initialLoading;else page">
    <mat-spinner></mat-spinner>
</div>

<ng-template #page>
    <div class="crud-form-body" [ngStyle]="{'display': (initialLoading && mode==='edit')?'none':''}">
        <ng-template [ngIf]="is_ready">
            <ng-error-handling></ng-error-handling>
                <div class="header_btn_container" *ngIf="viewConfig?.metadata?.formActions && mode==='edit'">
                    <span class="header_btns">
                        <ng-container>
                            <button mat-raised-button id="capture-btn" *ngIf="captureIdButton?.isShown" class="header_btn"
                                [ngStyle]="getStyles(captureIdButton)" id="{{captureIdButton.name}}-btn"
                                (click)="onAction(captureIdButton)" style="margin-right: 5px;">
                                <mat-icon *ngIf="captureIdButton.icon">{{captureIdButton.icon}}</mat-icon>
                                {{captureIdButton.name}}
                            </button>
                            <button mat-raised-button id="actions-btn" [matMenuTriggerFor]="menu">
                                <mat-icon>more_horiz</mat-icon>
                            </button>
                            <mat-menu #menu="matMenu">
                                <div *ngFor="let link of actionButtons">
                                    <button *ngIf="link?.isShown" mat-button class="header_btn"
                                        [ngStyle]="getStyles(link)" id="{{link.name}}-btn" (click)="onAction(link)">
                                        <mat-icon *ngIf="link.icon">{{link.icon}}</mat-icon>
                                        {{link.name}}
                                    </button>
                                </div>
                            </mat-menu>
                        </ng-container>
                    </span>
                </div>

            <div fxflexfill fxlayoutgap="10px grid" class="row full" [formGroup]="formGroup">
                <ng-container *ngFor="let config of _visibleControls">
                    <ng-container *ngIf="config?.type === 'fieldset'">
                        <mat-accordion style="width: 100%; margin: 10px;">
                            <mat-expansion-panel class="crud_expansion_panel" [expanded]="config.expanded !== undefined ? config.expanded : true">
                                <mat-expansion-panel-header [collapsedHeight]="'40px'" [expandedHeight]="'40px'">
                                    <mat-panel-title class="panel_title">
                                        <mat-label>{{config?.label}}</mat-label>
                                    </mat-panel-title>
                                </mat-expansion-panel-header>
                                <ng-container *ngFor="let config2 of config?.control?.fields">
                                    <div *ngIf="config2?.isEditable"
                                        style="width:25%;display:inline-block; box-sizing: border-box;"
                                        [style.width.%]="config2.cssWidth">
                                        <ng-crud-form-field class="FormCell" [style.flex.%]="config.cssWidth"
                                            [reset]="submit" [config]="config2" [mode]="mode" [formGroup]="formGroup"
                                            (elementDeleted)="elementDeleted($event)">
                                        </ng-crud-form-field>
                                    </div>
                                </ng-container>
                                <ng-container *ngIf="config?.control?.subFields">
                                        <mat-divider class="divider"></mat-divider>
                                        <ng-container *ngFor="let config3 of subFormsets; let i=index">
                                            <div class="formset_container">
                                                <ng-crud-formset class="FormCell" [config]="config3" [mode]="mode"
                                                    [formGroup]="formGroup">
                                                </ng-crud-formset>
                                            </div>
                                        </ng-container>
                                </ng-container>
                                <ng-container *ngIf="config?.control?.collapsibleFields">
                                        <mat-accordion style="width: 100%; margin: 10px;">
                                            <mat-expansion-panel id="collapsible_control" [expanded]="false">
                                                <mat-expansion-panel-header class="specific-class">
                                                    <mat-divider class="divider"></mat-divider>
                                                </mat-expansion-panel-header>
                                                <ng-container
                                                    *ngFor="let config2 of config?.control?.collapsibleFields">
                                                    <div *ngIf="config2?.isEditable"
                                                        style="width:25%;display:inline-block; box-sizing: border-box;"
                                                        [style.width.%]="config2.cssWidth">
                                                        <ng-crud-form-field class="FormCell"
                                                            [style.flex.%]="config.cssWidth" [reset]="submit"
                                                            [config]="config2" [mode]="mode" [formGroup]="formGroup"
                                                            (elementDeleted)="elementDeleted($event)">
                                                        </ng-crud-form-field>
                                                    </div>
                                                </ng-container>
                                            </mat-expansion-panel>
                                        </mat-accordion>
                                </ng-container>
                            </mat-expansion-panel>
                        </mat-accordion>
                    </ng-container>
                    <ng-container *ngIf="config.type !== 'fieldset' && config.type !== 'formset' && config.isEditable">
                        <div *ngIf="mode==='edit' || mode==='create';else search" class="crud_edit_fields">
                            <ng-crud-form-field class="FormCell" [mode]="mode" [reset]="submit" [formGroup]="formGroup"
                                [config]="config" (elementDeleted)="elementDeleted($event)">
                            </ng-crud-form-field>
                        </div>
                        <ng-template #search>
                            <ng-crud-form-field class="FormCell" [mode]="mode" [reset]="submit" [formGroup]="formGroup"
                                [config]="config" (elementDeleted)="elementDeleted($event)">
                            </ng-crud-form-field>
                        </ng-template>
                    </ng-container>
                    <ng-container *ngIf="config?.type === 'formset'">
                        <mat-accordion style="width: 100%; margin: 10px;">
                            <mat-expansion-panel class="crud_expansion_panel" [expanded]="true">
                                <mat-expansion-panel-header [collapsedHeight]="'40px'" [expandedHeight]="'40px'">
                                    <mat-panel-title class="panel_title">
                                        <mat-label>{{config?.label}}</mat-label>
                                    </mat-panel-title>
                                </mat-expansion-panel-header>
                                <ng-container *ngFor="let config of formsets; let i=index">
                                    <div class="formset_container">
                                        <ng-crud-formset class="FormCell" [config]="config" [mode]="mode" [formGroup]="formGroup">
                                        </ng-crud-formset>
                                    </div>
                                </ng-container>
                            </mat-expansion-panel>
                        </mat-accordion>
                    </ng-container>
                </ng-container>
            </div>

            <div class="row actions">
                <ng-container *ngIf="mode==='edit' || mode==='create' || openedInaialog;else search">
                    <ng-container *ngIf="!openedInaialog">
                        <button mat-raised-button id="saveAndEdit-btn" class="submit-button saveAndEdit"
                            [disabled]="disabled" (click)="_onSubmit('saveAndEdit')">
                            Save and Edit
                        </button>
                        <button mat-raised-button id="saveAndAdd-btn" class="submit-button saveAndAdd"
                            [disabled]="disabled" (click)="_onSubmit('saveAndAdd')">
                            Save and Add
                        </button>
                    </ng-container>
                    <button mat-raised-button id="save-btn" [disabled]="disabled"
                        [ngClass]="{'wide-save-btn': openedInaialog, 'submit-button saveAndAdd': !openedInaialog}"
                        (click)="_onSubmit('save')">
                        Save
                    </button>
                </ng-container>
                <ng-template #search>
                    <div class="search-actions">
                        <button mat-raised-button class="submit-button" (click)="_onSubmit()">
                            Search
                        </button>
                        <a mat-button (click)="_onReset()" class="reset_btn">
                            Reset
                        </a>
                    </div>
                </ng-template>
            </div>
        </ng-template>
    </div>
</ng-template>